// 
// File: Pump.cpp
// 
// Date: 24.12.14 17:11
// 
// Generated by: Idatto, version 1.3
// 
// Description:


//TODO
/*
 * 1. clean up code.
 * 2. summarize decreaseInsulin and decreaseGlucagon into one.
 * 3. summarize injectInsulin and injectGlucagon into one.
 * 4. code runable and rest of methods.
 * 5. test calculateNeededHormone for non-empty wrong value strings.
 * 6. refactor code. especially code that is redundant.
 * 7. test pump.
 */

#include "Pump.h"

#include <iostream>

#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <string.h>
#include <unistd.h>
#include <QObject>

using namespace std;

#define BUFLEN  100
#define EXIT__FAILURE   -1

int     i;
int     main (void);
int     fdes_body_to_pump; // fildescriptor for Body --> Pump
int     fdes_pump_to_body; // fildescriptor for Pump --> Body


/*
 * STRUCTS
 */
/**********************************
 * transmit_hormone_injection      *
 **********************************/

struct transmit_injection_hormones {
    float injected_insulin;
    float injected_glucagon;
} Injecting;

/**********************************
 * transmit_bloodsugar      *
 **********************************/

struct transmit_bloodsugar {
    float bloodSugarLevel;
} BodyStatus;

/*
 * END STRUCTS
 */



/*
 * FUNCTIONS
 */

/*
 * SUMMARIZE!
 */



// Injects either insulin or glucagon into the body.
//
// Parameters:
// - amount : int       the amount of FU that should be injected
// - insulin : bool     true if the hormone to inject is insulin, false if it is glucagon
bool Pump::injectHormone(int amount, bool insulin)
{
    if (insulin)
    {
        // inject insulin here
    } else
    {
        // inject glucagon here
    }
    return true;
}


/**
  *
  * summarized to above one injectHormone(amount, insulin)
  *
// Injects the insulin into the body.
// 
// Parameter:
// - amount: The amount of insulin which is injected into the body.
bool Pump::injectInsulin(float amount)
{
	return true;
}

// Injects the glucagon into the body.
// 
// Parameter:
// - amount: The amount of glucagon which is injected into the body.
bool Pump::injectGlucagon(float amount)
{
	return true;
}

*/

bool decreaseHormoneLevel(int amount, bool insulin)
{

}


/**
  *
  * summarized to the above
  *
// decreases insulin level in reservoir when injected to body and returns 
// “true” when done 
// 
// Parameter:
// - amount: The amount of insulin which is injected into the body needs to be 
//     reduced in the reservoir. 
bool Pump::decreaseInsulinLevel(float amount)
{
    QString err = "Reservoir Insulin too low!";
    if (amount <= this->getInsulinLevel())
    {
            insulinLevel-=amount;
            emit updateInsulinReservoir(insulinLevel);
            return true;
    }
    tracer.writeCriticalLog(err);
    return false;
}

// decreases glucagon level in reservoir when injected to body and returns
// “true” when done
//
// Parameter:
// - amount: The amount of glucagon which is injected into the body needs to be
//     reduced in the reservoir.
bool Pump::decreaseGlucagonLevel(float amount)
{
    QString err = "Reservoir Glucagon too low!";
    if (amount <= this->getGlucagonLevel())
    {
            glucagonLevel-=amount;
            emit updateGlucagonReservoir(glucagonLevel);
            return true;
    }
    tracer.writeCriticalLog(err);
    return false;
}
*/
/*
 * END SUMMARIZE!
 */


/*
 * author: Markus
 * BEGIN <<<<< meine bevorzugte loesung. mit sicherheit noch buggy!
 */
//see header!
//clean up! refactor code!

/*
 * what happens with non-empty string with value other than insulin or glucagon?
 */
float Pump::calculateNeededHormone(int targetBloodSugarLevel, int currentBloodSugarLevel, int hsf, string hormone)
{
    int difference;
    float fictInsUnit=0,fictGlucUnit=0;
    QString err = "Error! No valid hormone found!";
    string ins = "insulin";
    string gluc= "glucagon";

    if (!hormone.empty())
    {
        if(hormone == ins)
        {
            difference = currentBloodSugarLevel - targetBloodSugarLevel;
            fictInsUnit = difference / hsf;
            return fictInsUnit;
        }

        else if(hormone == gluc)
        {
            difference = targetBloodSugarLevel - currentBloodSugarLevel;
            fictInsUnit = difference / hsf;
            return fictGlucUnit;
        }
    }
    tracer.writeCriticalLog(err);
    return -1;
}
/*
 * END
 */
/*
 * END FUNCTIONS
 */


/*
 * GETTER
 */
// Checks the battery status and returns the value in percent.
// In case of a critical status (level smaller than 15%) the user will be 
// notified acoustically and the incident will be logged by the tracer. 
int Pump::getBatteryStatus()
{
    return this->batteryPowerLevel;
}

// Checks the entire pump (reservoir, mechanical parts) and returns “true” when 
// everything is working fine. 
bool Pump::getStatus()
{
	return true;
}

// Checks the blood sugar concentration and returns the value.
// Returns current blood sugar level.
float Pump::getCurrentBloodSugarLevel()
{
   return this->currentBloodSugarLevel;
};

// Returns the insulin level in the reservoir.
float Pump::getInsulinLevel()
{
    return this->insulinLevel;
}

// Returns the glucagon level in the reservoir.
float Pump::getGlucagonLevel()
{
    return this->glucagonLevel;
}
/*
 * END GETTER
 */


/*
 * SETTER
 */
// refills insulin and returns “true” when done
void Pump::refillInsulin()
{
    // Update UI
    emit updateInsulinReservoir(100);
}

// refills glucagon and returns “true” when done
void Pump::refillGlucagon()
{
    // Update UI
    emit updateGlucagonReservoir(100);
}
/*
 * END SETTER
 */


/*
 * RUNABLE
 */
//runable for Pump. Gets triggered by Scheduler.
bool Pump::runPump()
{
    return true;
}
/*
 * END RUNABLE
 */





